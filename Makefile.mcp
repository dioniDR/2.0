# Makefile.mcp - Reglas adicionales para MCP
# Este archivo se incluye en el Makefile principal

# Variables especÃ­ficas para MCP
MCP_BRIDGE = MCPBridge
MCP_BRIDGE_NATIVE = MCPBridge_native
MCP_CLIENT_SRCS = mcp_client.c
MAIN_MCP = main_mcp.c

# Compilar el bridge nativo
build_mcp_bridge:
	@echo "ðŸ”¨ Compilando MCP Bridge nativo..."
	@if [ ! -f $(MCP_BRIDGE).csproj ]; then \
		echo "âŒ No se encontrÃ³ MCPBridge.csproj"; \
		exit 1; \
	fi
	@echo "ðŸ“¦ Compilando a cÃ³digo nativo (puede tardar 1-2 minutos)..."
	@dotnet publish $(MCP_BRIDGE).csproj -r linux-x64 -c Release -p:PublishAot=true -o ./
	@if [ -f $(MCP_BRIDGE) ]; then \
		mv $(MCP_BRIDGE) $(MCP_BRIDGE_NATIVE); \
		chmod +x $(MCP_BRIDGE_NATIVE); \
		echo "âœ… Bridge nativo compilado: $(MCP_BRIDGE_NATIVE)"; \
	else \
		echo "âŒ Error al compilar el bridge"; \
		exit 1; \
	fi

# Compilar mÃ³dulo arch_mcp
arch_mcp: build_mcp_bridge
	@echo "ðŸ”¨ Compilando mÃ³dulo arch_mcp..."
	@if [ ! -f $(MCP_BRIDGE_NATIVE) ]; then \
		echo "âŒ Bridge nativo no encontrado. Ejecutando build_mcp_bridge..."; \
		make -f Makefile.mcp build_mcp_bridge; \
	fi
	$(CC) $(CFLAGS) -DMODO_ARCH_MCP \
		$(INCLUDES) -Imodulos/arch_mcp \
		-o gpt_arch_mcp $(MAIN_MCP) $(COMMON_SRCS) $(API_SRCS) $(MCP_CLIENT_SRCS) modulos/arch_mcp/executor.c
	@echo "âœ… MÃ³dulo arch_mcp compilado como: gpt_arch_mcp"
	@echo "ðŸš€ Para ejecutar: ./gpt_arch_mcp"

# Probar el bridge MCP
test_mcp:
	@echo "ðŸ” Probando MCP Bridge..."
	@if [ -f $(MCP_BRIDGE_NATIVE) ]; then \
		echo "Probando comando get_system_info..."; \
		echo '{"Action":"get_system_info"}' | ./$(MCP_BRIDGE_NATIVE) | head -n 1 | grep -q "Success" \
		&& echo "âœ… Bridge MCP funciona correctamente" \
		|| echo "âŒ Bridge MCP no responde correctamente"; \
	else \
		echo "âŒ Bridge nativo no encontrado. Ejecuta 'make build_mcp_bridge'"; \
	fi

# Probar comando especÃ­fico
test_mcp_command:
	@echo "ðŸ” Probando ejecuciÃ³n de comando..."
	@if [ -f $(MCP_BRIDGE_NATIVE) ]; then \
		echo '{"Action":"execute_command","Data":"uname -a"}' | ./$(MCP_BRIDGE_NATIVE); \
	else \
		echo "âŒ Bridge nativo no encontrado"; \
	fi

# Verificar dependencias para MCP
check_mcp_deps:
	@echo "ðŸ” Verificando dependencias MCP..."
	@which dotnet > /dev/null || (echo "âŒ .NET no estÃ¡ instalado"; exit 1)
	@dotnet --version | grep -q "8.0" || (echo "âŒ Se requiere .NET 8.0+"; exit 1)
	@echo "âœ… .NET $(shell dotnet --version) encontrado"
	@which gcc > /dev/null || (echo "âŒ GCC no estÃ¡ instalado"; exit 1)
	@echo "âœ… GCC encontrado"
	@echo "âœ… Todas las dependencias estÃ¡n disponibles"

# Limpiar archivos MCP
clean_mcp:
	@echo "ðŸ§¹ Limpiando archivos MCP..."
	rm -f gpt_arch_mcp
	rm -f $(MCP_BRIDGE_NATIVE)
	rm -f mcp_client.o
	rm -rf bin/ obj/
	@echo "âœ… Archivos MCP limpiados"

# Ayuda especÃ­fica para MCP
help_mcp:
	@echo "ðŸš€ Comandos MCP disponibles:"
	@echo "  make build_mcp_bridge  - Compilar bridge nativo"
	@echo "  make arch_mcp          - Compilar asistente con MCP"
	@echo "  make test_mcp          - Probar bridge MCP"
	@echo "  make test_mcp_command  - Probar ejecuciÃ³n de comando"
	@echo "  make check_mcp_deps    - Verificar dependencias"
	@echo "  make clean_mcp         - Limpiar archivos MCP"
	@echo "  make help_mcp          - Mostrar esta ayuda"
	@echo ""
	@echo "ðŸŽ¯ Para empezar:"
	@echo "  1. make check_mcp_deps"
	@echo "  2. make arch_mcp"
	@echo "  3. ./gpt_arch_mcp"

.PHONY: build_mcp_bridge arch_mcp test_mcp test_mcp_command check_mcp_deps clean_mcp help_mcp

# Variables adicionales para installer
INSTALLER_SRCS = installer_context.c

# Compilar asistente de instalaciÃ³n optimizado  
arch_installer: build_mcp_bridge
	@echo "ðŸ”¨ Compilando asistente de instalaciÃ³n optimizado..."
	@if [ ! -f $(MCP_BRIDGE_NATIVE) ]; then \
		echo "âŒ Bridge nativo no encontrado. Ejecutando build_mcp_bridge..."; \
		make -f Makefile.mcp build_mcp_bridge; \
	fi
	$(CC) $(CFLAGS) -DMODO_ARCH_INSTALLER \
		$(INCLUDES) -Imodulos/arch_installer \
		-o gpt_arch_installer main_installer.c $(COMMON_SRCS) $(API_SRCS) \
		$(MCP_CLIENT_SRCS) $(INSTALLER_SRCS) modulos/arch_installer/executor.c
	@echo "âœ… Asistente de instalaciÃ³n compilado como: gpt_arch_installer"
	@echo "ðŸš€ Para usar: ./gpt_arch_installer"
	@echo "ðŸ’° Optimizado para bajo costo (gpt-4o-mini + contexto limitado)"

# Probar optimizaciÃ³n de contexto
test_installer_context:
	@echo "ðŸ§ª Probando optimizaciÃ³n de contexto..."
	@echo "user	lsblk" > test_context.txt
	@echo "assistant	Mostrando discos disponibles" >> test_context.txt
	@echo "user	fdisk /dev/sda" >> test_context.txt
	@echo "assistant	Particionando disco" >> test_context.txt
	@echo "user	ls" >> test_context.txt
	@echo "assistant	Listando archivos" >> test_context.txt
	@mv test_context.txt context.txt
	@./gpt_arch_installer &
	@sleep 1
	@echo "/optimize" | ./gpt_arch_installer || true
	@echo "âœ… Prueba completada. Revisar context.txt optimizado"

# Crear distribuciÃ³n de instalaciÃ³n
dist_installer: arch_installer
	@echo "ðŸ“¦ Creando distribuciÃ³n de instalaciÃ³n..."
	@mkdir -p dist_installer/
	@cp gpt_arch_installer $(MCP_BRIDGE_NATIVE) dist_installer/
	@cp -r api/ dist_installer/
	@cp -r modulos/arch_installer/ dist_installer/modulos/
	@echo "#!/bin/bash" > dist_installer/install_arch.sh
	@echo "cd \"\$$(dirname \"\$$0\")\"" >> dist_installer/install_arch.sh  
	@echo "./gpt_arch_installer" >> dist_installer/install_arch.sh
	@chmod +x dist_installer/install_arch.sh
	@tar -czf gpt_arch_installer_dist.tar.gz dist_installer/
	@echo "âœ… DistribuciÃ³n creada: gpt_arch_installer_dist.tar.gz"
	@echo "   Descomprimir en Arch ISO y ejecutar: ./install_arch.sh"

.PHONY: arch_installer test_installer_context dist_installer